<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRPIN CITY BIRDS | Ornithological Hub</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --panel: rgba(10, 12, 16, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --c-birds: #ff9800;
            --c-inat: #74ac00;
            --c-red: #ef4444;
            --text: #f0f6fc;
            --text-dim: #8b949e;
            --accent: #58a6ff;
            --glass: blur(40px);
            --sidebar-w: 360px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
        }

        header {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 1px solid var(--border);
            z-index: 2200;
            flex-shrink: 0;
        }

        .logo-main {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.2rem;
            color: #fff;
            text-transform: uppercase;
            line-height: 1;
            letter-spacing: -1px;
        }

        .logo-sub {
            font-size: 0.75rem;
            color: var(--c-birds);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-left: 10px;
        }

        .time-box {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-dim);
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        main {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }

        .side-col {
            width: var(--sidebar-w);
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 14px;
            pointer-events: auto;
            position: relative;
            overflow-y: auto;
        }

        .side-col::-webkit-scrollbar {
            width: 2px;
        }

        .side-col::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        .glass {
            background: var(--panel);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .title {
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .title-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        #feed {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 5px;
            max-height: 380px;
        }

        #feed::-webkit-scrollbar {
            width: 2px;
        }

        #feed::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        .card {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }

        .card-img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .card-info {
            flex: 1;
            min-width: 0;
        }

        .card-name {
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            font-size: 0.7rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .stat-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 14px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 8px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-val {
            font-size: 1.2rem;
            font-weight: 700;
            display: block;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .stat-val.orange {
            color: var(--c-birds);
        }

        .stat-val.green {
            color: var(--c-inat);
        }

        .stat-val.red {
            color: var(--c-red);
        }

        .stat-lab {
            font-size: 0.55rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-top: 3px;
            line-height: 1.3;
        }

        /* Region selector tabs */
        .region-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .rtab {
            flex: 1;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            text-align: center;
            cursor: pointer;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            transition: 0.2s;
        }

        .rtab.active {
            background: rgba(88, 166, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Oblast Top Species */
        .top-species-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        .top-species-item:hover {
            border-color: var(--c-birds);
            background: rgba(255, 152, 0, 0.05);
        }

        .top-rank {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--c-birds);
            font-weight: 700;
            min-width: 18px;
        }

        .top-species-img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .top-species-info {
            flex: 1;
            min-width: 0;
        }

        .top-species-name {
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-species-count {
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        /* Oblast progress bar */
        .obl-bar-wrap {
            margin-bottom: 8px;
        }

        .obl-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            margin-bottom: 3px;
            color: var(--text-dim);
        }

        .obl-bar-label span:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            color: var(--text);
        }

        .obl-bar {
            height: 3px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            overflow: hidden;
        }

        .obl-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 1.2s ease;
        }

        /* Deep Dive */
        #deep-dive {
            position: absolute;
            top: 20px;
            right: 20px;
            width: var(--sidebar-w);
            height: calc(100% - 40px);
            background: var(--panel);
            backdrop-filter: var(--glass);
            border-radius: 18px;
            border: 1px solid var(--border);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.8);
            transform: translateX(120%);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            overflow-y: auto;
        }

        #deep-dive.active {
            transform: translateX(0);
        }

        .close-dive {
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dive-img {
            width: 100%;
            height: 180px;
            border-radius: 14px;
            object-fit: cover;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .dive-name {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .dive-sci {
            font-size: 0.8rem;
            font-style: italic;
            color: var(--text-dim);
            margin-bottom: 15px;
        }

        .dive-text {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-dim);
        }

        .badge {
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-right: 4px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .badge-red {
            background: rgba(239, 68, 68, 0.2);
            color: var(--c-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-trans {
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent);
            border: 1px solid rgba(88, 166, 255, 0.2);
        }

        .badge-green {
            background: rgba(116, 172, 0, 0.2);
            color: var(--c-inat);
            border: 1px solid rgba(116, 172, 0, 0.2);
        }

        .dive-section-title {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin: 14px 0 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .dive-obs-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .dive-obs-item {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .dive-obs-img {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            object-fit: cover;
        }

        .dive-obs-info {
            flex: 1;
            min-width: 0;
        }

        .dive-obs-loc {
            font-size: 0.65rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dive-obs-date {
            font-size: 0.6rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .a-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        .a-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .a-fill {
            height: 100%;
            background: var(--accent);
            transition: 1s;
        }

        .source-tag {
            font-size: 0.55rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--c-inat);
            padding: 1px 5px;
            border-radius: 3px;
            border: 1px solid rgba(116, 172, 0, 0.3);
            background: rgba(116, 172, 0, 0.08);
        }

        .loader-dots {
            display: inline-flex;
            gap: 3px;
            align-items: center;
        }

        .loader-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent);
            animation: blink 1s infinite;
        }

        .loader-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: 0.2;
            }

            40% {
                opacity: 1;
            }
        }

        @media (max-width: 900px) {
            .ui-layer {
                flex-direction: column;
                padding: 10px;
                overflow-y: auto;
                pointer-events: auto;
                background: rgba(0, 0, 0, 0.5);
            }

            .side-col {
                width: 100%;
                height: auto;
                overflow-y: visible;
            }

            #deep-dive {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                height: 70vh;
                border-radius: 18px 18px 0 0;
                transform: translateY(120%);
            }

            #deep-dive.active {
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <header>
        <div style="display:flex; align-items:baseline; flex-wrap:wrap; gap:8px;">
            <div class="logo-main">Irpin City Birds</div>
            <div class="logo-sub">Ornithological Intelligence Hub</div>
        </div>
        <div class="time-box" id="time">00:00:00</div>
    </header>

    <main>
        <video id="video-bg" autoplay muted playsinline></video>

        <div class="ui-layer">
            <!-- ===== LEFT PANEL: Live Feed + Irpin Local ===== -->
            <div class="side-col">
                <div class="glass" style="flex-shrink:0;">
                    <div class="title"><span class="title-dot" style="background:var(--c-inat);"></span>–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å ‚Äî
                        –Ü—Ä–ø—ñ–Ω—å (15 –∫–º)</div>

                    <!-- Zone tabs -->
                    <div class="region-tabs">
                        <div class="rtab active" id="tab-irpin" onclick="switchTab('irpin')">üìç –Ü—Ä–ø—ñ–Ω—å</div>
                        <div class="rtab" id="tab-kyiv" onclick="switchTab('kyiv')">üèôÔ∏è –ö–∏—ó–≤</div>
                        <div class="rtab" id="tab-oblast" onclick="switchTab('oblast')">üó∫Ô∏è –û–±–ª–∞—Å—Ç—å</div>
                    </div>

                    <div id="feed"></div>
                    <div id="feed-loader" style="text-align:center; padding:12px 0; display:none;">
                        <div class="loader-dots"><span></span><span></span><span></span></div>
                    </div>
                </div>
            </div>

            <!-- ===== RIGHT PANEL: Stats & Analytics ===== -->
            <div class="side-col">

                <!-- Metrics block -->
                <div class="glass">
                    <div class="title"><span class="title-dot" style="background:var(--accent);"></span>Metrics
                        Analytics (Local)</div>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <span class="stat-val orange" id="c-total">0</span>
                            <div class="stat-lab">–í–∏–¥—ñ–≤<br>–Ü—Ä–ø—ñ–Ω—å</div>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="c-threat">0</span>
                            <div class="stat-lab">–°—Ç–∞—Ç—É—Å<br>–ó–∞–≥—Ä–æ–∑–∏</div>
                        </div>
                    </div>
                    <!-- Oblast-wide metrics -->
                    <div class="stat-grid-3">
                        <div class="stat-box">
                            <span class="stat-val green" id="c-oblast-species">‚Äî</span>
                            <div class="stat-lab">–í–∏–¥—ñ–≤<br>–û–±–ª–∞—Å—Ç—å</div>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="c-oblast-obs">‚Äî</span>
                            <div class="stat-lab">–°–ø–æ—Å—Ç–µ–∂.<br>–û–±–ª–∞—Å—Ç—å</div>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="c-kyiv-species">‚Äî</span>
                            <div class="stat-lab">–í–∏–¥—ñ–≤<br>–ö–∏—ó–≤</div>
                        </div>
                    </div>
                </div>

                <!-- IUCN breakdown -->
                <div class="glass">
                    <div class="title"><span class="title-dot" style="background:var(--c-red);"></span>–ü–æ–ø—É–ª—è—Ü—ñ–π–Ω–∏–π
                        –ü—É–ª—å—Å (IUCN)</div>
                    <div id="stat-taxa"></div>
                </div>

                <!-- Top Species Oblast -->
                <div class="glass">
                    <div class="title"><span class="title-dot" style="background:var(--c-birds);"></span>–¢–æ–ø –í–∏–¥—ñ–≤ ‚Äî
                        –ö–∏—ó–≤—Å—å–∫–∞ –û–±–ª–∞—Å—Ç—å</div>
                    <div id="top-species-list">
                        <div style="color:var(--text-dim); font-size:0.75rem; text-align:center; padding:10px;">
                            <div class="loader-dots"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                </div>

                <!-- Weather + Node Status -->
                <div class="glass">
                    <div class="title"><span class="title-dot" style="background:#a855f7;"></span>Weather Sync Irpin
                    </div>
                    <div id="weather-info" style="font-size:0.75rem; line-height:1.8;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                </div>

                <div class="glass">
                    <div class="title">Real-Time Node Status</div>
                    <div style="font-size:0.65rem; color:var(--text-dim); line-height:1.8;">
                        Irpin Node: <b style="color:var(--text)">50.51¬∞N, 30.24¬∞E ¬∑ r=15km</b><br>
                        Kyiv Node: <b style="color:var(--text)">50.45¬∞N, 30.52¬∞E ¬∑ r=20km</b><br>
                        Oblast Node: <b style="color:var(--text)">50.45¬∞N, 30.52¬∞E ¬∑ r=80km</b><br>
                        API: <span style="color:var(--c-inat)">‚óè iNaturalist v1</span><br>
                        Status: <span style="color:var(--c-inat)">‚óè Connected</span>
                    </div>
                </div>
            </div>

            <!-- ===== Deep Dive Panel ===== -->
            <div id="deep-dive">
                <div class="close-dive" onclick="closeDive()">‚úï –ù–∞–∑–∞–¥</div>
                <img id="dive-img" class="dive-img" src="" alt="">
                <h2 id="dive-name" class="dive-name"></h2>
                <div id="dive-sci" class="dive-sci"></div>
                <div id="dive-badges"></div>
                <div id="dive-obs-section"></div>
                <div id="dive-text" class="dive-text"></div>
            </div>
        </div>
    </main>

    <script>
        const state = {
            irpin: [],
            kyiv: [],
            oblast: [],
            activeTab: 'irpin',
            vIndex: 1,
            vTotal: 10,
            TAXA_COLORS: {
                'LC': '#58a6ff', 'NT': '#a855f7', 'VU': '#ff9800',
                'EN': '#ef4444', 'CR': '#b91c1c', 'DD': '#6b7280', 'Normal': '#ff9800'
            }
        };

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function init() {
            setupVideo();
            setInterval(() => {
                document.getElementById('time').innerText = new Date().toLocaleTimeString('uk-UA');
            }, 1000);

            // Fetch all three zones in parallel
            fetchZone('irpin');
            fetchZone('kyiv');
            fetchZoneOblast();
            fetchWeather();

            setInterval(() => {
                fetchZone('irpin');
                fetchZone('kyiv');
                fetchZoneOblast();
                fetchWeather();
            }, 300000); // refresh every 5 min
        }

        // ‚îÄ‚îÄ‚îÄ VIDEO SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setupVideo() {
            const video = document.getElementById('video-bg');
            state.vIndex = 1; // Start from the first video

            const setVideoSource = () => {
                video.src = `${state.vIndex}.mp4`;
            };

            setVideoSource();

            video.onended = () => {
                state.vIndex = (state.vIndex % state.vTotal) + 1;
                setVideoSource();
                video.play();
            };

            video.onerror = () => {
                // If video fails, try the next one after a short delay
                setTimeout(() => {
                    state.vIndex = (state.vIndex % state.vTotal) + 1;
                    setVideoSource();
                    video.play();
                }, 2000);
            };
        }

        // ‚îÄ‚îÄ‚îÄ FETCH ZONE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ZONES = {
            irpin: { lat: 50.51, lng: 30.24, radius: 15, label: '–Ü—Ä–ø—ñ–Ω—å' },
            kyiv: { lat: 50.45, lng: 30.52, radius: 20, label: '–ö–∏—ó–≤' },
        };

        async function fetchZone(zone) {
            const z = ZONES[zone];
            try {
                const res = await fetch(
                    `https://api.inaturalist.org/v1/observations?taxon_id=3&lat=${z.lat}&lng=${z.lng}&radius=${z.radius}&per_page=100&order=desc&order_by=created_at&quality_grade=research`
                );
                const json = await res.json();
                state[zone] = parseObs(json.results || []);
                if (state.activeTab === zone) renderFeed();
                updateMetrics();
            } catch (e) {
                console.warn(`Zone ${zone} fetch error`, e);
            }
        }

        // Oblast: wider coverage, grab top species by count
        async function fetchZoneOblast() {
            try {
                // Species endpoint ‚Äì returns top species by observation count in Kyiv Oblast
                const resSpecies = await fetch(
                    `https://api.inaturalist.org/v1/observations/species_counts?taxon_id=3&lat=50.45&lng=30.52&radius=80&per_page=20`
                );
                const jsSpecies = await resSpecies.json();

                // Total observations count for the oblast
                const resCount = await fetch(
                    `https://api.inaturalist.org/v1/observations?taxon_id=3&lat=50.45&lng=30.52&radius=80&per_page=1`
                );
                const jsCount = await resCount.json();

                const totalObs = jsCount.total_results || 0;
                const topSpecies = (jsSpecies.results || []).map(r => ({
                    id: r.taxon.id,
                    name: r.taxon.preferred_common_name || r.taxon.name,
                    sci: r.taxon.name,
                    count: r.count,
                    img: r.taxon.default_photo ? r.taxon.default_photo.square_url : null,
                    iucn: r.taxon.conservation_status ? r.taxon.conservation_status.status_name : 'LC'
                }));

                document.getElementById('c-oblast-obs').innerText = totalObs >= 1000
                    ? (totalObs / 1000).toFixed(1) + 'k' : totalObs;
                document.getElementById('c-oblast-species').innerText = jsSpecies.total_results || topSpecies.length;

                renderTopSpecies(topSpecies);

                // Also add oblast general feed to state
                const resFeed = await fetch(
                    `https://api.inaturalist.org/v1/observations?taxon_id=3&lat=50.45&lng=30.52&radius=80&per_page=80&order=desc&order_by=created_at&quality_grade=research`
                );
                const jsFeed = await resFeed.json();
                state.oblast = parseObs(jsFeed.results || []);
                if (state.activeTab === 'oblast') renderFeed();
                updateMetrics();

            } catch (e) {
                console.warn('Oblast fetch error', e);
                document.getElementById('top-species-list').innerHTML =
                    '<div style="color:var(--text-dim); font-size:0.7rem; text-align:center;">–î–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ</div>';
            }
        }

        function parseObs(results) {
            return results.map(o => ({
                id: o.id,
                name: o.taxon ? (o.taxon.preferred_common_name || o.taxon.name) : '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ç–∞—Ö',
                sci: o.taxon ? o.taxon.name : '',
                img: (o.photos && o.photos[0])
                    ? o.photos[0].url.replace('square', 'medium')
                    : 'https://via.placeholder.com/150/111/fff?text=iNat',
                thumb: (o.photos && o.photos[0]) ? o.photos[0].url : null,
                loc: o.place_guess || '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å',
                date: o.observed_on || o.created_at ? (o.observed_on || o.created_at.slice(0, 10)) : '‚Äî',
                iucn: (o.taxon && o.taxon.conservation_status) ? o.taxon.conservation_status.status : 'LC',
                allPhotos: (o.photos || []).map(p => p.url.replace('square', 'medium')),
                obscured: o.obscured,
                quality: o.quality_grade,
                user: o.user ? o.user.login : '‚Äî'
            }));
        }

        // ‚îÄ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(zone) {
            state.activeTab = zone;
            ['irpin', 'kyiv', 'oblast'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.toggle('active', t === zone);
            });
            renderFeed();
        }

        // ‚îÄ‚îÄ‚îÄ RENDER FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderFeed() {
            const feed = document.getElementById('feed');
            const data = state[state.activeTab];

            if (!data || data.length === 0) {
                feed.innerHTML = `<div style="padding:20px; color:var(--text-dim); font-size:0.75rem; text-align:center;">
                –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö...<br>
                <div class="loader-dots" style="margin-top:8px; justify-content:center;"><span></span><span></span><span></span></div>
            </div>`;
                return;
            }

            // Unique by species
            const speciesMap = new Map();
            data.forEach(d => { if (!speciesMap.has(d.sci)) speciesMap.set(d.sci, d); });
            const list = Array.from(speciesMap.values());

            document.getElementById('c-total').innerText = list.length;

            // Count threats
            const threatened = list.filter(d => ['VU', 'EN', 'CR'].includes(d.iucn)).length;
            document.getElementById('c-threat').innerText = threatened;

            feed.innerHTML = '';
            list.forEach(d => {
                const color = state.TAXA_COLORS[d.iucn] || state.TAXA_COLORS.Normal;
                const isThreaten = ['VU', 'EN', 'CR'].includes(d.iucn);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                <div style="position:relative;">
                    <img src="${d.img}" class="card-img" onerror="this.src='https://via.placeholder.com/50/111/888?text=üê¶'">
                    ${isThreaten ? '<div style="position:absolute;top:-4px;right:-4px;width:10px;height:10px;background:var(--c-red);border-radius:50%;border:2px solid var(--panel);"></div>' : ''}
                </div>
                <div class="card-info">
                    <div class="card-name">${d.name}</div>
                    <div class="card-meta">
                        <span style="color:${color}">‚óè</span>
                        <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.loc}</span>
                        <span style="font-size:0.5rem;background:rgba(255,255,255,0.05);padding:2px 4px;border-radius:3px;flex-shrink:0;">${d.iucn}</span>
                    </div>
                    <div class="card-meta" style="margin-top:2px;">
                        <span class="source-tag">iNat</span>
                        <span>${d.date}</span>
                        <span>üë§ ${d.user}</span>
                    </div>
                </div>`;
                card.onclick = () => showDive(d);
                feed.appendChild(card);
            });

            updateIucnBars(data);
        }

        // ‚îÄ‚îÄ‚îÄ UPDATE IUCN BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateIucnBars(data) {
            const orders = {};
            data.forEach(d => { orders[d.iucn] = (orders[d.iucn] || 0) + 1; });
            const total = data.length;
            document.getElementById('stat-taxa').innerHTML = Object.entries(orders)
                .sort((a, b) => b[1] - a[1])
                .map(([n, c]) => `
                <div class="a-row">
                    <span>IUCN <b>${n}</b></span>
                    <span>${c}</span>
                </div>
                <div class="a-bar"><div class="a-fill" style="width:${c / total * 100}%; background:${state.TAXA_COLORS[n] || '#fff'}"></div></div>
            `).join('');
        }

        function updateMetrics() {
            // Kyiv species count
            const kyivMap = new Map();
            state.kyiv.forEach(d => { if (!kyivMap.has(d.sci)) kyivMap.set(d.sci, d); });
            document.getElementById('c-kyiv-species').innerText = kyivMap.size || '‚Äî';
        }

        // ‚îÄ‚îÄ‚îÄ TOP SPECIES (OBLAST) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderTopSpecies(list) {
            if (!list.length) return;
            const max = list[0].count;
            const el = document.getElementById('top-species-list');
            el.innerHTML = list.slice(0, 8).map((s, i) => {
                const color = i === 0 ? '#ff9800' : i === 1 ? '#8b949e' : i === 2 ? '#b87333' : 'var(--text-dim)';
                const barColor = state.TAXA_COLORS[s.iucn] || state.TAXA_COLORS.Normal;
                return `
            <div class="obl-bar-wrap">
                <div class="obl-bar-label">
                    <span>${i + 1}. ${s.name}</span>
                    <span style="color:${color}; font-weight:700; font-family:'JetBrains Mono',mono;">${s.count}</span>
                </div>
                <div class="obl-bar">
                    <div class="obl-bar-fill" style="width:${s.count / max * 100}%; background:${barColor};"></div>
                </div>
            </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ DEEP DIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function showDive(d) {
            const p = document.getElementById('deep-dive');
            document.getElementById('dive-img').src = d.img;
            document.getElementById('dive-name').innerText = d.name;
            document.getElementById('dive-sci').innerText = d.sci;
            document.getElementById('dive-text').innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞—É–∫–æ–≤–æ—ó –¥–æ–≤—ñ–¥–∫–∏...';
            document.getElementById('dive-obs-section').innerHTML = '';

            const isThreaten = ['VU', 'EN', 'CR'].includes(d.iucn);
            document.getElementById('dive-badges').innerHTML = `
            <span class="badge ${isThreaten ? 'badge-red' : 'badge-trans'}">IUCN: ${d.iucn}</span>
            <span class="badge badge-green">iNaturalist</span>
        `;
            p.classList.add('active');

            // Fetch all observations of this species in region
            try {
                const obsRes = await fetch(
                    `https://api.inaturalist.org/v1/observations?taxon_name=${encodeURIComponent(d.sci)}&lat=50.45&lng=30.52&radius=80&per_page=5&order=desc&order_by=created_at&photos=true`
                );
                const obsJson = await obsRes.json();
                const obsSection = document.getElementById('dive-obs-section');
                const recent = (obsJson.results || []).slice(0, 4);

                if (recent.length > 0) {
                    obsSection.innerHTML = `<div class="dive-section-title">üó∫Ô∏è –û—Å—Ç–∞–Ω–Ω—ñ —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è ‚Äî –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.</div>
                <div class="dive-obs-list">
                ${recent.map(o => `
                    <div class="dive-obs-item">
                        <img class="dive-obs-img" src="${o.photos[0] ? o.photos[0].url : ''}" onerror="this.style.display='none'">
                        <div class="dive-obs-info">
                            <div class="dive-obs-loc">üìç ${o.place_guess || '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'}</div>
                            <div class="dive-obs-date">üìÖ ${(o.observed_on || '').slice(0, 10)} ¬∑ üë§ ${o.user ? o.user.login : '‚Äî'}</div>
                        </div>
                    </div>`).join('')}
                </div>`;
                }
            } catch (e) { }

            // Wikipedia info
            try {
                const w = await fetch(`https://uk.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(d.name.split(' (')[0])}`);
                const j = await w.json();
                if (j.extract) {
                    document.getElementById('dive-text').innerText = j.extract;
                } else {
                    const en = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(d.sci)}`);
                    const ej = await en.json();
                    if (ej.extract) {
                        const tr = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=uk&dt=t&q=${encodeURIComponent(ej.extract.substring(0, 500))}`);
                        const tj = await tr.json();
                        document.getElementById('dive-text').innerText = tj[0].map(x => x[0]).join('');
                        document.getElementById('dive-badges').innerHTML +=
                            `<span class="badge badge-trans">UA AI SYNC</span>`;
                    } else {
                        document.getElementById('dive-text').innerText = '–û–ø–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö.';
                    }
                }
            } catch (e) {
                document.getElementById('dive-text').innerText = '–í—É–∑–æ–ª –∑–Ω–∞–Ω—å —Ç–∏–º—á–∞—Å–æ–≤–æ –æ—Ñ–ª–∞–π–Ω.';
            }
        }

        function closeDive() {
            document.getElementById('deep-dive').classList.remove('active');
        }

        // ‚îÄ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function fetchWeather() {
            try {
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=50.51&longitude=30.24&current_weather=true&hourly=relative_humidity_2m,precipitation_probability&timezone=Europe/Kiev`);
                const data = await r.json();
                const cw = data.current_weather;
                const wDescription = {
                    0: '–Ø—Å–Ω–æ ‚òÄÔ∏è', 1: '–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ üå§Ô∏è', 2: '–•–º–∞—Ä–Ω–æ ‚õÖ', 3: '–ü–æ—Ö–º—É—Ä–æ ‚òÅÔ∏è',
                    45: '–¢—É–º–∞–Ω üå´Ô∏è', 48: '–ö—Ä–∏–∂–∞–Ω–∏–π —Ç—É–º–∞–Ω üå´Ô∏è', 51: '–ú—Ä—è–∫–∞ üå¶Ô∏è',
                    61: '–î–æ—â üåßÔ∏è', 71: '–°–Ω—ñ–≥ ‚ùÑÔ∏è', 95: '–ì—Ä–æ–∑–∞ ‚õàÔ∏è'
                }[cw.weathercode] || `–ö–æ–¥ ${cw.weathercode}`;

                // Get current hour humidity
                const now = new Date();
                const hourIdx = now.getHours();
                const humidity = data.hourly && data.hourly.relative_humidity_2m
                    ? data.hourly.relative_humidity_2m[hourIdx] + '%'
                    : '‚Äî';
                const precipProb = data.hourly && data.hourly.precipitation_probability
                    ? data.hourly.precipitation_probability[hourIdx] + '%'
                    : '‚Äî';

                document.getElementById('weather-info').innerHTML = `
                –°—Ç–∞–Ω: <span style="color:#fff">${wDescription}</span><br>
                –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <span style="color:#fff">${cw.temperature}¬∞C</span><br>
                –í—ñ—Ç–µ—Ä: <span style="color:#fff">${cw.windspeed} –∫–º/–≥–æ–¥</span><br>
                –í–æ–ª–æ–≥—ñ—Å—Ç—å: <span style="color:#fff">${humidity}</span><br>
                –Ü–º–æ–≤. –æ–ø–∞–¥—ñ–≤: <span style="color:${parseInt(precipProb) > 50 ? 'var(--c-red)' : 'var(--accent)'}">${precipProb}</span>
            `;
            } catch (e) {
                document.getElementById('weather-info').innerText = '–ú–µ—Ç–µ–æ–≤—É–∑–æ–ª –æ—Ñ–ª–∞–π–Ω.';
            }
        }

        window.onload = init;
    </script>
</body>

</html>
